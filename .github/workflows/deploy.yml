name: Build and Deploy

# Required permissions for GitHub Pages deployment
permissions:
  contents: write
  pages: write
  id-token: write

env:
  CI: false
  GITHUB_USERNAME: ${{ github.repository_owner }}
  REACT_APP_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  USE_GITHUB_DATA: "true"
  MEDIUM_USERNAME: "saadpasta"

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main
  schedule:
    - cron: "0 12 * * 1"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository 🛎️
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js 🔧
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies 📦
        run: |
          # Show versions for debugging
          node -v
          npm -v
          
          # Clean install with fallback to regular install
          npm ci --prefer-offline --no-audit || npm install --prefer-offline --no-audit
          
          # Verify installation
          echo "Installed packages:"
          npm list --depth=0
          
          echo "Checking for react-scripts:"
          npx which react-scripts || echo "react-scripts not found in PATH"

      - name: Build project 🏗️
        run: |
          npm run build
          
          # Verify build output
          ls -la build/

      - name: Deploy to GitHub Pages 🚀
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository-name: prithwish-rgb/Developer-Folio
          branch: gh-pages
          folder: build
          clean: true
          clean-exclude: |
            CNAME
            .nojekyll
            .gitignore
          commit-message: "Deploy: ${{ github.sha }}"
          target-folder: /